{% load i18n %}

<style>
table{
  width: 100%;
  height: 400px;
}

tbody{
  overflow-y: auto;
  border: solid 1px #ddd;
}

th{
  background: #579ddb;
  color: #fff;
  width: 100%;
  padding: 9px 5px;
  border-bottom: 1px solid #D3E5F4;
  font-weight: 600;
}

tr{
  padding: 8px 5px;
  border-bottom: 1px solid #D3E5F4
}

tr:first-child{
  background-color: #f8f8f8;
  color: #777;
  font-weight: 600;
}

tr:nth-child(odd) {
    background: #F5FAFE;
}

</style>

<div style="height: fit-content">
  <div class="row widget-container">
    <div class="form-group">
      <div class="relative">
        <div>
          <label class="control-label widget-input-label">
            {% trans "Node Group" %}</label>
            <div class="widget-input" style="display: inline-block" data-bind="select2Query: {
              select2Config: {
                      clickBubble: false,
                      disabled: false,
                      data: cards(),
                      value: selectedNodeGroup,
                      allowClear: true,
                      multiple: false,
                      placeholder: 'Select Node'}}"></div>
                    </div>
        <!--ko if: selectedNodeGroup()-->
        <div class="widget-input">
          <label class="control-label widget-input-label">
            {% trans "Node" %}</label>
          <div style="display: inline-block" data-bind="select2Query: {
            select2Config: {
              clickBubble: false,
              disabled: false,
              data: nodes(),
              value: selectedNode,
              allowClear: true,
              multiple: false,
              placeholder: 'Select Node'}}"></div>
            </div>
            <!--/ko-->
            <!--ko if: selectedNode-->
            <div class="widget-input">
              <div style="display: inline-block" data-bind='component: {
                        name: "concept-multiselect-widget",
                        params: {
                          config: {defaultValue:"", label:"Concept Value", options:[], placeholder:"Select an option"},
                          value: selectedVal,
                          node: concept_node(),
                          type: "resource-editor",
                        }
                    }'></div>
                  </div>
                  <!--/ko-->
                  <!--ko if: selectedVal -->
                  
                  <div class="permission-header">
                    <h4>{% trans 'Set Permissions for this instance' %}</h4>
                    <h5>
                      {% trans 'By default only you have access to this record. You can
                      set permissions for specific people or groups by selecting to whom
                      you will grant access' %}
                    </h5>
                  </div>
        <div class="permission-control"></div>
        <div class="permission-list">
          <div class="applied-permissions">
            <div class="permission-list-table">
              <div class="permissions-list-header">
                <div class="identities-column">{% trans 'Person/Group' %}</div>
                <div class="permissions-column">{% trans 'Permissions' %}</div>
              </div>
              
              <div class="permissions-list-table-body" style="height: fit-content">
                <div data-bind="foreach: userGroups">
                  <div class="permissions-table-row">
                    <div style="display: inline-flex; height: 20px">
                      <div class="identities-column">
                        <span data-bind="text: $data.identityName"></span>
                      </div>
                      <div class="permissions-column">
                        <span class="switch-small"
                        data-bind="component: { name: 'views/components/simple-switch', params: {value: $data.identityVal}}"></span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!--/ko-->
        <table>
          <thead>
            <th>Node Group</th>
            <th>Node</th>
            <th>Value</th>
            <th style="visibility: hidden; "></th>
            <th style="visibility: hidden;"></th>
          </thead>
          <tbody data-bind="foreach: rules">
            <tr>
              <td>
                <span data-bind="text: $parent.getNodeText($data.selectedNodeGroup())"></span>
              </td>
              <td>
                <span data-bind="text: $parent.getNodeText($data.selectedNode())"></span>
              </td>
              <td>
                <span data-bind="text: $parent.getConceptText($data.selectedVal())"></span>
              </td>
              <td>
                <a href="#" style="color: blue" data-bind="click: $parent.editRule.bind($data)">Edit</a>
              </td>
              <td>
                <a href="#" style="color: red" data-bind="click: $parent.removeRule">Remove</a>
              </td>
            </tr>
          </tbody>
        </table>
        <button style="float:right" data-bind="click: addRule">Add Rule</button>
      </div>
    </div>
    
    
    <!-- <button data-bind="click: function() {console.log(ko.mapping.toJS(rules()))}">
      DUMP RULES |
    </button>
    <button data-bind="click: function() {this.rules.removeAll()}">
      | Remove ALL!
    </button> -->
  </div>
</div>